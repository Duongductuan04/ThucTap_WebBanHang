@model SimpleTaskApp.Statistics.Dto.StatisticsDto
@{
    ViewBag.Title = "Thống kê";
    var filter = ViewBag.Filter as SimpleTaskApp.Statistics.Dto.StatisticsFilterDto;
}

<div class="container mt-4">
    <h2 class="mb-4">📊 Thống kê Dashboard</h2>

    <!-- Bộ lọc -->
    <form method="get" class="row g-3 mb-4">
        <div class="col-md-2">
            <label for="day" class="form-label">Ngày</label>
            <input type="number" name="Day" class="form-control" id="day"
                   value="@(filter?.Day.HasValue == true ? filter.Day.ToString() : "")"
                   min="1" max="31" />
        </div>
        <div class="col-md-2">
            <label for="month" class="form-label">Tháng</label>
            <input type="number" name="Month" class="form-control" id="month"
                   value="@(filter?.Month ?? DateTime.Now.Month)" min="1" max="12" />
        </div>
        <div class="col-md-2">
            <label for="year" class="form-label">Năm</label>
            <input type="number" name="Year" class="form-control" id="year"
                   value="@(filter?.Year ?? DateTime.Now.Year)" min="2000" max="2100" />
        </div>
        <div class="col-md-2 align-self-end">
            <button type="submit" class="btn btn-primary w-100">Lọc</button>
        </div>
        <div class="col-md-2 align-self-end">
            <a href="@Url.Action("Index", "Statistics", new { area = "Admin" })"
               class="btn btn-secondary w-100">Reset</a>
        </div>
    </form>
    <!-- 4 Info Boxes -->
    <div class="row">
        <div class="col-md-3">
            <div class="card text-white bg-info mb-3 shadow">
                <div class="card-body">
                    <h5 class="card-title">📱 Sản phẩm đã bán</h5>
                    <p class="card-text fs-4 fw-bold">@Model.TotalProductsSold</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success mb-3 shadow">
                <div class="card-body">
                    <h5 class="card-title">📦 Đơn hàng</h5>
                    <p class="card-text fs-4 fw-bold">@Model.TotalOrders</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3 shadow">
                <div class="card-body">
                    <h5 class="card-title">👤 Khách hàng</h5>
                    <p class="card-text fs-4 fw-bold">@Model.TotalCustomers</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger mb-3 shadow">
                <div class="card-body">
                    <h5 class="card-title">💰 Doanh thu</h5>
                    <p class="card-text fs-4 fw-bold">@Model.MonthlyRevenue.ToString("N0") đ</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Biểu đồ doanh thu theo tháng -->
    <div class="card shadow mt-4">
        <div class="card-body">
            <h5 class="card-title mb-3">📈 Doanh thu theo tháng (@(filter?.Year ?? DateTime.Now.Year))</h5>
            <canvas id="revenueChart" height="100"
                    data-revenues='@Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.RevenuesByMonth))'>
            </canvas>
        </div>
    </div>
    @if (Model.RevenueByBrandPerCategory != null && Model.RevenueByBrandPerCategory.Any())
    {
        <h4 class="mt-4 mb-3 text-center">
            💼 Doanh thu theo từng Thương hiệu năm @(filter?.Year ?? DateTime.Now.Year)
        </h4>

        @foreach (var cat in Model.RevenueByBrandPerCategory)
        {
            <div class="card shadow mt-3">
                <div class="card-body text-center">
                    <h5 class="card-title mb-3">🍏 @cat.CategoryName</h5>
                    @if (cat.BrandRevenues != null && cat.BrandRevenues.Any())
                    {
                        <canvas class="pie-chart" id="pieChart_@cat.CategoryId"
                                width="250" height="250"
                                data-brands='@Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(cat.BrandRevenues))'>
                        </canvas>
                    }
                    else
                    {
                        <p>📌 Biểu đồ tròn không có dữ liệu cho năm @(filter?.Year ?? DateTime.Now.Year)</p>
                    }
                </div>
            </div>
        }
    }
    else
    {
        <p class="text-center mt-3">📌 Không có dữ liệu doanh thu theo thương hiệu cho năm @(filter?.Year ?? DateTime.Now.Year)</p>
    }
    @if (Model.LatestOrders != null && Model.LatestOrders.Any())
    {
        <h4 class="mt-5 mb-3 text-center">🆕 10 Đơn hàng mới nhất</h4>
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Mã đơn hàng</th>
                        <th>Ngày tạo</th>
                        <th>Trạng thái</th>
                        <th>Tổng tiền</th>
                        <th>Sản phẩm</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var order in Model.LatestOrders)
                    {
                        <tr>
                            <td>@order.OrderId</td>
                            <td>@order.CreationTime.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>
                                @switch (order.Status)
                                {
                                    case 0:
                                        @:Chưa xử lý
                                        break;
                                    case 1:
                                        @:Đang giao
                                        break;
                                    case 2:
                                        @:Đã giao
                                        break;
                                    case 3:
                                        @:Đã hủy
                                        break;
                                    default:
                                        @:Không xác định
                                        break;
                                }
                            </td>
                            <td>@order.TotalAmount.ToString("N0") đ</td>
                            <td>
                                <ul class="list-unstyled mb-0">
                                    @foreach (var item in order.Items)
                                    {
                                        <li>@item.MobilePhoneName (@item.Quantity)</li>
                                    }
                                </ul>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <p class="text-center mt-3">📌 Không có đơn hàng nào.</p>
    }


</div>
@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="~/view-resources/Views/Statistics/Index.js"></script>
    <script src="~/view-resources/Views/Statistics/statistics-pie.js"></script>

}
