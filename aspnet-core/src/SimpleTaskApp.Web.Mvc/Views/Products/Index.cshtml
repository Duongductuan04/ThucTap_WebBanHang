@model List<SimpleTaskApp.MobilePhones.Dto.MobilePhoneDto>

@{
    ViewBag.Title = "Sản phẩm";
    Layout = "~/Views/Shared/Layout/_LayoutFrontend.cshtml";

    int currentPage = ViewBag.CurrentPage ?? 1;
    int pageSize = ViewBag.PageSize ?? 20;
    int totalCount = ViewBag.TotalCount ?? Model.Count;
    int totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
    if (totalPages < 1) totalPages = 1;
    if (currentPage > totalPages) currentPage = totalPages;

    string searchQuery = ViewBag.SearchQuery as string;

    // Pagination rút gọn
    int pageRange = 2; // số trang hiển thị trước/sau trang hiện tại
    int startPage = Math.Max(2, currentPage - pageRange);
    int endPage = Math.Min(totalPages - 1, currentPage + pageRange);
}

<div class="container my-5">

    <!-- Tiêu đề -->
    <div class="mb-3">
        <h2 class="fw-bold">
            @if (!string.IsNullOrEmpty(searchQuery))
            {
                <text>Kết quả tìm kiếm cho "@searchQuery"</text>
            }
            else
            {
                @ViewBag.SelectedCategoryName
            }
            <small class="text-muted">(@totalCount sản phẩm)</small>
        </h2>
    </div>

    <!-- Lọc theo thương hiệu -->
    <div class="mb-3">
        <strong class="me-2">Thương hiệu:</strong>

        <a href="@Url.Action("Index", "Products", new { categoryId = ViewBag.SelectedCategoryId, sort = ViewBag.CurrentSort, query = searchQuery })"
           class="btn btn-outline-secondary btn-sm mb-1 @(ViewBag.SelectedBrand == null ? "active" : "")">Tất cả</a>

        @if (ViewBag.Brands != null)
        {
            foreach (var b in ViewBag.Brands as List<string>)
            {
                <a href="@Url.Action("Index", "Products", new { categoryId = ViewBag.SelectedCategoryId, brand = b, sort = ViewBag.CurrentSort, query = searchQuery })"
                   class="btn btn-outline-secondary btn-sm mb-1 @(ViewBag.SelectedBrand == b ? "active" : "")">@b</a>
            }
        }
    </div>

    <!-- Sắp xếp -->
    <div class="mb-4">
        <strong class="me-2">Lọc:</strong>
        <a href="@Url.Action("Index", "Products", new { sort = "priceDesc", categoryId = ViewBag.SelectedCategoryId, brand = ViewBag.SelectedBrand, query = searchQuery })"
           class="btn btn-outline-secondary btn-sm mb-1 @(ViewBag.CurrentSort == "priceDesc" ? "active" : "")">Giá cao → thấp</a>
        <a href="@Url.Action("Index", "Products", new { sort = "priceAsc", categoryId = ViewBag.SelectedCategoryId, brand = ViewBag.SelectedBrand, query = searchQuery })"
           class="btn btn-outline-secondary btn-sm mb-1 @(ViewBag.CurrentSort == "priceAsc" ? "active" : "")">Giá thấp → cao</a>
        <a href="@Url.Action("Index", "Products", new { sort = "new", categoryId = ViewBag.SelectedCategoryId, brand = ViewBag.SelectedBrand, query = searchQuery })"
           class="btn btn-outline-secondary btn-sm mb-1 @(ViewBag.CurrentSort == "new" ? "active" : "")">Hàng mới về</a>
        <a href="@Url.Action("Index", "Products", new { sort = "sale", categoryId = ViewBag.SelectedCategoryId, brand = ViewBag.SelectedBrand, query = searchQuery })"
           class="btn btn-outline-secondary btn-sm mb-1 @(ViewBag.CurrentSort == "sale" ? "active" : "")">Khuyến mãi</a>
    </div>

    <!-- Danh sách sản phẩm -->
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-4">
        @if (Model != null && Model.Count > 0)
        {
            foreach (var item in Model)
            {
                <div class="col">
                    <div class="card h-100 shadow-sm product-card border-0">
                        <div class="position-relative">
                            <img src="@item.ImageUrl" class="card-img-top p-3" alt="@item.Name" />
                            @if (item.IsOnSale)
                            {
                                <span class="badge bg-danger position-absolute top-0 start-0 m-2">SALE</span>
                            }
                        </div>
                        <div class="card-body text-center">
                            <h6 class="card-title mb-2">@item.Name</h6>
                            <p class="card-text mb-2">
                                @if (item.IsOnSale && item.DiscountPrice.HasValue)
                                {
                                    <span class="text-muted text-decoration-line-through me-2">@item.Price.ToString("N0") đ</span>
                                    <span class="text-danger fw-bold">@item.DiscountPrice.Value.ToString("N0") đ</span>
                                }
                                else
                                {
                                    <span class="fw-bold text-dark">@item.Price.ToString("N0") đ</span>
                                }
                            </p>
                            <a asp-controller="Products" asp-action="Detail" asp-route-id="@item.Id" class="btn btn-outline-primary btn-sm w-100">Xem chi tiết</a>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <p class="text-muted text-center">Không có sản phẩm nào.</p>
            </div>
        }
    </div>

    <!-- Pagination rút gọn -->
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            <!-- Previous -->
            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                <a class="page-link" href="@Url.Action("Index", "Products", new { page = currentPage - 1, categoryId = ViewBag.SelectedCategoryId, brand = ViewBag.SelectedBrand, sort = ViewBag.CurrentSort, query = searchQuery })">Trước</a>
            </li>

            <!-- Trang đầu -->
            <li class="page-item @(currentPage == 1 ? "active" : "")">
                <a class="page-link" href="@Url.Action("Index", "Products", new { page = 1, categoryId = ViewBag.SelectedCategoryId, brand = ViewBag.SelectedBrand, sort = ViewBag.CurrentSort, query = searchQuery })">1</a>
            </li>

            @if (startPage > 2)
            {
                <li class="page-item disabled"><span class="page-link">...</span></li>
            }

            <!-- Các trang giữa -->
            @for (int i = startPage; i <= endPage; i++)
            {
                <li class="page-item @(i == currentPage ? "active" : "")">
                    <a class="page-link" href="@Url.Action("Index", "Products", new { page = i, categoryId = ViewBag.SelectedCategoryId, brand = ViewBag.SelectedBrand, sort = ViewBag.CurrentSort, query = searchQuery })">@i</a>
                </li>
            }

            @if (endPage < totalPages - 1)
            {
                <li class="page-item disabled"><span class="page-link">...</span></li>
            }

            <!-- Trang cuối -->
            @if (totalPages > 1)
            {
                <li class="page-item @(currentPage == totalPages ? "active" : "")">
                    <a class="page-link" href="@Url.Action("Index", "Products", new { page = totalPages, categoryId = ViewBag.SelectedCategoryId, brand = ViewBag.SelectedBrand, sort = ViewBag.CurrentSort, query = searchQuery })">@totalPages</a>
                </li>
            }

            <!-- Next -->
            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                <a class="page-link" href="@Url.Action("Index", "Products", new { page = currentPage + 1, categoryId = ViewBag.SelectedCategoryId, brand = ViewBag.SelectedBrand, sort = ViewBag.CurrentSort, query = searchQuery })">Sau</a>
            </li>
        </ul>
    </nav>
</div>
