@using SimpleTaskApp.MobilePhones.Dto
@model List<OrderDto>

@{
    Layout = "~/Views/Shared/Layout/_LayoutFrontend.cshtml";
    ViewBag.Title = "Đơn hàng của tôi";

    int currentPage = ViewBag.CurrentPage ?? 1;
    int pageSize = ViewBag.PageSize ?? 15;
    int totalCount = ViewBag.TotalCount ?? Model.Count;
    int totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
    if (totalPages < 1) totalPages = 1;
    if (currentPage > totalPages) currentPage = totalPages;

    int statusValue = ViewBag.StatusValue ?? -1;

    string statusLabel = statusValue switch
    {
        0 => "🕒 Đang xử lý",
        1 => "🚚 Đang giao",
        2 => "✅ Hoàn thành",
        3 => "❌ Đã hủy",
        _ => "Tất cả đơn hàng"
    };
}

<div class="order-container">
    <h1 class="page-title">@statusLabel</h1>

    <!-- Bộ lọc trạng thái -->
    <div class="mb-3">
        <strong class="me-2">Trạng thái:</strong>

        <a href="@Url.Action("Index", "UserOrders", new { status = (int?)null, page = 1, pageSize = pageSize })"
           class="btn btn-outline-secondary btn-sm mb-1 @(statusValue == -1 ? "active" : "")">
            Tất cả
        </a>
        <a href="@Url.Action("Index", "UserOrders", new { status = 0, page = 1, pageSize = pageSize })"
           class="btn btn-outline-secondary btn-sm mb-1 @(statusValue == 0 ? "active" : "")">
            🕒 Đang xử lý
        </a>
        <a href="@Url.Action("Index", "UserOrders", new { status = 1, page = 1, pageSize = pageSize })"
           class="btn btn-outline-secondary btn-sm mb-1 @(statusValue == 1 ? "active" : "")">
            🚚 Đang giao
        </a>
        <a href="@Url.Action("Index", "UserOrders", new { status = 2, page = 1, pageSize = pageSize })"
           class="btn btn-outline-secondary btn-sm mb-1 @(statusValue == 2 ? "active" : "")">
            ✅ Hoàn thành
        </a>
        <a href="@Url.Action("Index", "UserOrders", new { status = 3, page = 1, pageSize = pageSize })"
           class="btn btn-outline-secondary btn-sm mb-1 @(statusValue == 3 ? "active" : "")">
            ❌ Đã hủy
        </a>
    </div>

    @if (Model == null || !Model.Any())
    {
        <div class="empty-orders text-center">
            <div class="empty-icon">📦</div>
            <h3 class="empty-title">Chưa có đơn hàng nào</h3>
            <p class="empty-text">Hãy mua sắm và quay lại để xem đơn hàng của bạn tại đây.</p>
            <a href="@Url.Action("Index", "Home")" class="btn btn-primary">Mua sắm ngay</a>
        </div>
    }
    else
    {
        @foreach (var order in Model)
        {
            string statusClass = order.Status switch
            {
                0 => "status-processing",
                1 => "status-shipping",
                2 => "status-completed",
                3 => "status-cancelled",
                _ => "status-processing"
            };

            string orderStatusText = order.Status switch
            {
                0 => "🕒 Đang xử lý",
                1 => "🚚 Đang giao hàng",
                2 => "✅ Đã hoàn thành",
                3 => "❌ Đã hủy",
                _ => "Không xác định"
            };

            <div class="order-card mb-4">
                <div class="order-header d-flex justify-content-between align-items-center">
                    <h5 class="order-id mb-0">Đơn hàng #@order.Id</h5>
                    <span class="order-status @statusClass">@orderStatusText</span>
                </div>

                <div class="order-products mt-3">
                    <table class="table table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Ảnh</th>
                                <th>Sản phẩm</th>
                                <th>Số lượng</th>
                                <th>Đơn giá</th>
                                <th>Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in order.OrderDetails)
                            {
                                <tr>
                                    <td>
                                        <img src="@item.ImageUrl" alt="@item.MobilePhoneName"
                                             class="img-thumbnail" style="width:70px;height:70px;object-fit:cover;" />
                                    </td>
                                    <td>@item.MobilePhoneName</td>
                                    <td>@item.Quantity</td>
                                    <td>@item.UnitPrice.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))</td>
                                    <td>@((item.Quantity * item.UnitPrice).ToString("C0", new System.Globalization.CultureInfo("vi-VN")))</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="order-footer d-flex justify-content-between flex-wrap mt-3">
                    <div class="order-info">
                        <div><strong>Ngày đặt: </strong> @order.CreationTime.ToString("dd/MM/yyyy HH:mm")</div>
                        <div><strong>Người nhận: </strong> @order.RecipientName</div>
                        <div><strong>Điện thoại: </strong> @order.RecipientPhone</div>
                        <div><strong>Địa chỉ: </strong> @order.RecipientAddress</div>
                        @if (!string.IsNullOrEmpty(order.Note))
                        {
                            <div><strong>Ghi chú: </strong> @order.Note</div>
                        }
                    </div>

                <div class="order-total text-end">
                    <div><strong>Tạm tính: </strong>
                        @((order.OrderDetails?.Sum(x => x.Quantity * x.UnitPrice) ?? 0m)
                            .ToString("C0", new System.Globalization.CultureInfo("vi-VN")))
                    </div>
                    <div><strong>Phí vận chuyển: </strong>
                        @( (order.ShippingFee).ToString("C0", new System.Globalization.CultureInfo("vi-VN")) )
                    </div>
                        <hr class="my-2" />
                        <div class="fw-bold fs-3">
                            <strong>Tổng tiền: </strong> <span class="text-danger fw-bold">@(order.FinalAmount.ToString("N0", new System.Globalization.CultureInfo("vi-VN"))) đ</span>
                        </div>

                </div>
                </div>

            </div>
        }

        <!-- Phân trang -->
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("Index", "UserOrders", new { page = currentPage - 1, pageSize = pageSize, status = statusValue })">Trước</a>
                </li>
                @for (int i = 1; i <= totalPages; i++)
                {
                    <li class="page-item @(i == currentPage ? "active" : "")">
                        <a class="page-link" href="@Url.Action("Index", "UserOrders", new { page = i, pageSize = pageSize, status = statusValue })">@i</a>
                    </li>
                }
                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("Index", "UserOrders", new { page = currentPage + 1, pageSize = pageSize, status = statusValue })">Sau</a>
                </li>
            </ul>
        </nav>
    }
</div>
